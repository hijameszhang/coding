<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Koa Cookie &amp; Session | Web Developer</title>
    <meta name="description" content="Web developer">
    <link rel="shortcut icon" type="icon" href="/coding/coding/images/logo/my.jpg">
    
    <link rel="preload" href="/coding/assets/css/0.styles.9a06647f.css" as="style"><link rel="preload" href="/coding/assets/js/app.bda66ca1.js" as="script"><link rel="preload" href="/coding/assets/js/2.5301b3be.js" as="script"><link rel="preload" href="/coding/assets/js/33.96063c19.js" as="script"><link rel="prefetch" href="/coding/assets/js/10.65e9a4bb.js"><link rel="prefetch" href="/coding/assets/js/11.9e3fd327.js"><link rel="prefetch" href="/coding/assets/js/12.45322000.js"><link rel="prefetch" href="/coding/assets/js/13.91278df4.js"><link rel="prefetch" href="/coding/assets/js/14.24d512d2.js"><link rel="prefetch" href="/coding/assets/js/15.482cbe32.js"><link rel="prefetch" href="/coding/assets/js/16.f2696b58.js"><link rel="prefetch" href="/coding/assets/js/17.4caa8eae.js"><link rel="prefetch" href="/coding/assets/js/18.c623d12e.js"><link rel="prefetch" href="/coding/assets/js/19.ad7b5a63.js"><link rel="prefetch" href="/coding/assets/js/20.effcc9e9.js"><link rel="prefetch" href="/coding/assets/js/21.2ddb2a1f.js"><link rel="prefetch" href="/coding/assets/js/22.70c9ac91.js"><link rel="prefetch" href="/coding/assets/js/23.9f5bec45.js"><link rel="prefetch" href="/coding/assets/js/24.2c097041.js"><link rel="prefetch" href="/coding/assets/js/25.ef69a840.js"><link rel="prefetch" href="/coding/assets/js/26.33c71d45.js"><link rel="prefetch" href="/coding/assets/js/27.9b42ef41.js"><link rel="prefetch" href="/coding/assets/js/28.e1cfa454.js"><link rel="prefetch" href="/coding/assets/js/29.fd9a92f3.js"><link rel="prefetch" href="/coding/assets/js/3.070fe044.js"><link rel="prefetch" href="/coding/assets/js/30.0204da64.js"><link rel="prefetch" href="/coding/assets/js/31.fa7024e0.js"><link rel="prefetch" href="/coding/assets/js/32.67999162.js"><link rel="prefetch" href="/coding/assets/js/34.7efda74e.js"><link rel="prefetch" href="/coding/assets/js/35.a871816e.js"><link rel="prefetch" href="/coding/assets/js/36.37f69431.js"><link rel="prefetch" href="/coding/assets/js/37.26e9bb20.js"><link rel="prefetch" href="/coding/assets/js/38.33dcec0e.js"><link rel="prefetch" href="/coding/assets/js/39.b3a3dae7.js"><link rel="prefetch" href="/coding/assets/js/4.8789dbc3.js"><link rel="prefetch" href="/coding/assets/js/40.ac4acda2.js"><link rel="prefetch" href="/coding/assets/js/41.7e49bde6.js"><link rel="prefetch" href="/coding/assets/js/42.666dbd62.js"><link rel="prefetch" href="/coding/assets/js/43.8976499b.js"><link rel="prefetch" href="/coding/assets/js/44.c241484b.js"><link rel="prefetch" href="/coding/assets/js/45.86cf049d.js"><link rel="prefetch" href="/coding/assets/js/46.f21f338c.js"><link rel="prefetch" href="/coding/assets/js/47.289d9933.js"><link rel="prefetch" href="/coding/assets/js/48.57af0318.js"><link rel="prefetch" href="/coding/assets/js/49.29d5599b.js"><link rel="prefetch" href="/coding/assets/js/5.32ebd2a0.js"><link rel="prefetch" href="/coding/assets/js/50.350b242c.js"><link rel="prefetch" href="/coding/assets/js/51.1cfc7d3f.js"><link rel="prefetch" href="/coding/assets/js/52.07abf413.js"><link rel="prefetch" href="/coding/assets/js/53.587f011d.js"><link rel="prefetch" href="/coding/assets/js/54.9bb24747.js"><link rel="prefetch" href="/coding/assets/js/55.7850accb.js"><link rel="prefetch" href="/coding/assets/js/56.d02b4a21.js"><link rel="prefetch" href="/coding/assets/js/57.099fab41.js"><link rel="prefetch" href="/coding/assets/js/58.13ce710b.js"><link rel="prefetch" href="/coding/assets/js/59.28b0136e.js"><link rel="prefetch" href="/coding/assets/js/6.a94c891c.js"><link rel="prefetch" href="/coding/assets/js/60.022fbb2c.js"><link rel="prefetch" href="/coding/assets/js/61.00fe7075.js"><link rel="prefetch" href="/coding/assets/js/62.6dc716f0.js"><link rel="prefetch" href="/coding/assets/js/63.12b12c53.js"><link rel="prefetch" href="/coding/assets/js/64.2db53cef.js"><link rel="prefetch" href="/coding/assets/js/65.0d7c8758.js"><link rel="prefetch" href="/coding/assets/js/66.010151f5.js"><link rel="prefetch" href="/coding/assets/js/67.8c86ff96.js"><link rel="prefetch" href="/coding/assets/js/7.99d9b27b.js"><link rel="prefetch" href="/coding/assets/js/8.309b23b6.js"><link rel="prefetch" href="/coding/assets/js/9.1df69252.js">
    <link rel="stylesheet" href="/coding/assets/css/0.styles.9a06647f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coding/" class="home-link router-link-active"><img src="/coding/images/logo/my.jpg" alt="Web Developer" class="logo"> <span class="site-name can-hide">Web Developer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coding/vue/" class="nav-link">Vue</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Web</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/coding/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/coding/js/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/coding/typescript/" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/coding/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/coding/nodejs/" class="nav-link router-link-active">Node.js</a></li><li class="dropdown-item"><!----> <a href="/coding/web/" class="nav-link">Web</a></li><li class="dropdown-item"><!----> <a href="/coding/interview/" class="nav-link">Interview</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding/git/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">BusinessManagement</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding/trainer/" class="nav-link">讲师</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/hijameszhang/coding" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/coding/vue/" class="nav-link">Vue</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Web</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/coding/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/coding/js/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/coding/typescript/" class="nav-link">TypeScript</a></li><li class="dropdown-item"><!----> <a href="/coding/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/coding/nodejs/" class="nav-link router-link-active">Node.js</a></li><li class="dropdown-item"><!----> <a href="/coding/web/" class="nav-link">Web</a></li><li class="dropdown-item"><!----> <a href="/coding/interview/" class="nav-link">Interview</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Tools</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding/git/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">BusinessManagement</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/coding/trainer/" class="nav-link">讲师</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/hijameszhang/coding" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Node.js</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/coding/nodejs/1-nodejs-env.html" class="sidebar-link">Nodejs 环境搭建</a></li><li><a href="/coding/nodejs/2-nodejs-http.html" class="sidebar-link">Node.js Http模块</a></li><li><a href="/coding/nodejs/3-nodejs-basic.html" class="sidebar-link">Node.js 基础</a></li><li><a href="/coding/nodejs/4-koa.html" class="sidebar-link">Koa</a></li><li><a href="/coding/nodejs/5-koa-router.html" class="sidebar-link">Koa Router</a></li><li><a href="/coding/nodejs/6-mongodb.html" class="sidebar-link">MongoDB</a></li><li><a href="/coding/nodejs/7-koa-static.html" class="sidebar-link">Koa-static中间件</a></li><li><a href="/coding/nodejs/8-koa-session-cookie.html" class="active sidebar-link">Koa Cookie &amp; Session</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#koa-cookie" class="sidebar-link">Koa Cookie</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#代码示例" class="sidebar-link">代码示例</a></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#中间件-koa-cookie" class="sidebar-link">中间件 koa-cookie</a></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#安装-koa-cookie" class="sidebar-link">安装 koa-cookie:</a></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#示例代码-不使用koa-router" class="sidebar-link">示例代码(不使用koa-router)</a></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#示例代码-使用koa-router" class="sidebar-link">示例代码(使用koa-router)</a></li></ul></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#koa-session" class="sidebar-link">Koa Session</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#session存储在mongodb中" class="sidebar-link">session存储在MongoDB中</a></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#安装-koa-session" class="sidebar-link">安装 koa-session</a></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#完整示例代码" class="sidebar-link">完整示例代码:</a></li></ul></li><li class="sidebar-sub-header"><a href="/coding/nodejs/8-koa-session-cookie.html#相关链接" class="sidebar-link">相关链接</a></li></ul></li><li><a href="/coding/nodejs/9-koa-template.html" class="sidebar-link">模板引擎</a></li><li><a href="/coding/nodejs/91-koa-mysql.html" class="sidebar-link">MySQL</a></li><li><a href="/coding/nodejs/92-koa-redis.html" class="sidebar-link">Redis</a></li><li><a href="/coding/nodejs/93-koa-project.html" class="sidebar-link">从开发到部署上线</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa-cookie-session">Koa Cookie &amp; Session</h1> <h2 id="koa-cookie">Koa Cookie</h2> <p>koa提供了从上下文直接读取、写入cookie的方法</p> <ul><li>ctx.cookies.get(name, [options]), 读取上下文请求中的cookie</li> <li>ctx.cookies.set(name, value, [options]), 在上下文中写入cookie
koa 中操作的cookies是使用了npm的cookies <a href="https://github.com/pillarjs/cookies" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>模块，所以在读写cookie的使用参数与该模块的使用一致。</li></ul> <h3 id="代码示例">代码示例</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span> <span class="token keyword">async</span> <span class="token punctuation">(</span> <span class="token parameter">ctx</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> ctx<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/hello'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
      <span class="token string">'cid'</span><span class="token punctuation">,</span> 
      <span class="token string">'hello james'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        domain<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>              <span class="token comment">// cookie所在的domain(域名)</span>
        path<span class="token punctuation">:</span> <span class="token string">'/hello'</span><span class="token punctuation">,</span>                   <span class="token comment">// cookie所在的path(路径)</span>
        maxAge<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>       <span class="token comment">// cookie的有效时长, 这里为1小时</span>
        expires<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2019-07-02'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// cookie的失效时间</span>
        httpOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                  <span class="token comment">// 是否只用于http请求中获取</span>
        overwrite<span class="token punctuation">:</span> <span class="token boolean">false</span>                  <span class="token comment">// 是否允许重写</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'cookie has set ok'</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello world'</span> 
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器运行在 http://127.0.0.1:3000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如上代码所示, 若访问路径: <code>http://127.0.0.1:3000/hello</code>, 即会给浏览器写入cookie. 最终结果如下图所示:</p> <p><img src="/coding/images/cookie.png" alt="images.png"></p> <h3 id="中间件-koa-cookie">中间件 koa-cookie</h3> <p>在开源并封装好的<a href="https://github.com/varunpal/koa-cookie" target="_blank" rel="noopener noreferrer">koa-cookie<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 安装和使用也很简单.</p> <h3 id="安装-koa-cookie">安装 koa-cookie:</h3> <div class="language- extra-class"><pre class="language-text"><code>npm install koa-cookie
</code></pre></div><p>或者</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add koa-cookie
</code></pre></div><h3 id="示例代码-不使用koa-router">示例代码(不使用koa-router)</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">'koa'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> cookie <span class="token keyword">from</span> <span class="token string">'koa-cookie'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cookies <span class="token operator">=</span> ctx<span class="token punctuation">.</span>cookie<span class="token punctuation">;</span>
  <span class="token comment">/*
    if cookies sent are of the form: 'name=abc; age=20; token = xyz;'
    Then ctx.cookie is an object of the form:
    {
      name: 'abc',
      age: '20',
      token: 'xyz'
    }
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="示例代码-使用koa-router">示例代码(使用koa-router)</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cookie <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cookies <span class="token operator">=</span> context<span class="token punctuation">.</span>cookie<span class="token punctuation">;</span>
  <span class="token comment">/*
    if cookies sent are of the form: 'name=abc; age=20; token = xyz;'
    Then ctx.cookie is an object of the form:
    {
      name: 'abc',
      age: '20',
      token: 'xyz'
    }
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
app
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="koa-session">Koa Session</h2> <p>koa原生功能只提供了cookie的操作，但是没有提供session操作。session就只用自己实现或者通过第三方中间件实现。
Session实现的常见方案可能有:</p> <ul><li>存储在内存中</li> <li>存储在数据库中, 如Mysql, mongodb, 或者内存数据库中(如: Redis, memcached等)</li></ul> <h3 id="session存储在mongodb中">session存储在MongoDB中</h3> <p>将session存储在mongodb中, 需要使用到中间件: <code>koa-session</code>, 提供存储介质的读写接口.</p> <p>实现思路:</p> <ul><li>将sessionId和对于的数据存到数据库</li> <li>将数据库的存储的sessionId存到页面的cookie中</li> <li>根据cookie的sessionId去获取对于的session信息</li></ul> <h3 id="安装-koa-session">安装 koa-session</h3> <p>安装:</p> <div class="language- extra-class"><pre class="language-text"><code>npm install koa-session
</code></pre></div><p>或者</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add koa-session
</code></pre></div><h3 id="完整示例代码">完整示例代码:</h3> <p><strong>index.js</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> SessionStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./sessionStore.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完整代码在下面会提供出 </span>

<span class="token keyword">const</span> db <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost/james&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>



<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用路由</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 密钥字符串</span>
app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'some secret string'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// session 配置信息</span>
<span class="token keyword">const</span> <span class="token constant">CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  key<span class="token punctuation">:</span> <span class="token string">'koa:sess'</span><span class="token punctuation">,</span>
  maxAge<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  signed<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  rolling<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  autoCommit<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 自动提交</span>
  store<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SessionStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      collection<span class="token punctuation">:</span> <span class="token string">'sessions'</span><span class="token punctuation">,</span>       <span class="token comment">//数据库集合</span>
      connection<span class="token punctuation">:</span> db<span class="token punctuation">,</span>         <span class="token comment">// 数据库链接实例</span>
      expires<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>        <span class="token comment">// 默认时间为1天</span>
      name<span class="token punctuation">:</span> <span class="token string">'session'</span>               <span class="token comment">// 保存session的表名称</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  renew<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 默认为false, 当用户session快过期时, 是否自动续期</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 以中间件的方式使用session</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取session对象</span>
  <span class="token keyword">const</span> session <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">;</span>

  <span class="token comment">// 给session赋值</span>
  session<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span><span class="token string">'james'</span><span class="token punctuation">,</span>
      email<span class="token punctuation">:</span><span class="token string">'hellojameszhang@163.com'</span><span class="token punctuation">,</span>
      age <span class="token punctuation">:</span> <span class="token number">31</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello world'</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><div class="tip custom-block"><p>sessionStore可根据自己的需要自行实现, 实现在的相关规范可参考<a href="https://github.com/koajs/session#external-session-stores" target="_blank" rel="noopener noreferrer">koa-session<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <p><strong>sessionStore.js</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  _id<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
  updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      expires<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 1 day</span>
      type<span class="token punctuation">:</span> Date
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MongooseStore</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      collection <span class="token operator">=</span> <span class="token string">'sessions'</span><span class="token punctuation">,</span>
      connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      expires <span class="token operator">=</span> <span class="token number">86400</span><span class="token punctuation">,</span>
      name <span class="token operator">=</span> <span class="token string">'Session'</span>
      <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'params connection is not collection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token keyword">const</span> updatedAt <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>schema<span class="token punctuation">.</span>updatedAt<span class="token punctuation">,</span> expires <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>schema<span class="token punctuation">,</span> updatedAt <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">destroy</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> session<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token punctuation">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token keyword">get</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> data<span class="token punctuation">,</span> maxAge<span class="token punctuation">,</span> <span class="token punctuation">{</span> changed<span class="token punctuation">,</span> rolling <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>changed <span class="token operator">||</span> rolling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> id<span class="token punctuation">,</span> data<span class="token punctuation">,</span> updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> record<span class="token punctuation">,</span> <span class="token punctuation">{</span> upsert<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> safe<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> useFindAndModify<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">create</span> <span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongooseStore</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MongooseStore
</code></pre></div><p>至此, 已简单实现koa session保存到mongodb. 访问: http://127.0.0.1:3000/, 查看cookie, 最终结果可能如下:
<img src="/coding/images/session.png" alt="images.png"></p> <p>查看mongodb数据库中的集合sessions, 即可发现数据已保存到mongodb中.</p> <div class="language- extra-class"><pre class="language-text"><code>&gt; use james
switched to db james
&gt; show collections
hellos
sessions
users
&gt; db.sessions.find()
{ &quot;_id&quot; : &quot;8b5de860-432b-4798-bff6-ae3af53163c6&quot;, &quot;__v&quot; : 0, &quot;data&quot; : { &quot;userInf
o&quot; : { &quot;name&quot; : &quot;james&quot;, &quot;email&quot; : &quot;hellojameszhang@163.com&quot;, &quot;age&quot; : 31 }, &quot;_ex
pire&quot; : 1562164691767, &quot;_maxAge&quot; : 86400000 }, &quot;updatedAt&quot; : ISODate(&quot;2019-07-02
T14:38:11.768Z&quot;) }
{ &quot;_id&quot; : &quot;24f2f586-65c3-4d40-92eb-b2dfd6c85c0e&quot;, &quot;__v&quot; : 0, &quot;data&quot; : { &quot;userInf
o&quot; : { &quot;name&quot; : &quot;james&quot;, &quot;email&quot; : &quot;hellojameszhang@163.com&quot;, &quot;age&quot; : 31 }, &quot;_ex
pire&quot; : 1562164706024, &quot;_maxAge&quot; : 86400000 }, &quot;updatedAt&quot; : ISODate(&quot;2019-07-02
T14:38:26.024Z&quot;) }
{ &quot;_id&quot; : &quot;64248f70-93f8-42aa-be87-e49cdb6fc241&quot;, &quot;__v&quot; : 0, &quot;data&quot; : { &quot;userInf
o&quot; : { &quot;name&quot; : &quot;james&quot;, &quot;email&quot; : &quot;hellojameszhang@163.com&quot;, &quot;age&quot; : 31 }, &quot;_ex
pire&quot; : 1562164797496, &quot;_maxAge&quot; : 86400000 }, &quot;updatedAt&quot; : ISODate(&quot;2019-07-02
T14:39:57.496Z&quot;) }
&gt;
</code></pre></div><h2 id="相关链接">相关链接</h2> <ul><li><a href="https://github.com/koajs/session#external-session-stores" target="_blank" rel="noopener noreferrer">github: koa-session<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/varunpal/koa-cookie" target="_blank" rel="noopener noreferrer">github: koa-cookie<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://gitlab.com/wondermonger/koa-session-mongoose" target="_blank" rel="noopener noreferrer">github: koa-session-mongoose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/2/2019, 11:22:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/coding/nodejs/7-koa-static.html" class="prev">
          Koa-static中间件
        </a></span> <span class="next"><a href="/coding/nodejs/9-koa-template.html">
          模板引擎
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/coding/assets/js/app.bda66ca1.js" defer></script><script src="/coding/assets/js/2.5301b3be.js" defer></script><script src="/coding/assets/js/33.96063c19.js" defer></script>
  </body>
</html>
